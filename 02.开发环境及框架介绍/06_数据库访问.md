# 数据库访问

> 对标 JPA/Hibernate 和 MyBatis

## 方案对比

| Go 方案 | Java 类比 | 特点 |
|---------|-----------|------|
| `database/sql` | JDBC | 标准库，手写 SQL |
| GORM | JPA/Hibernate | ORM，自动映射 |
| sqlc | MyBatis | SQL 优先，代码生成 |
| Ent | JPA + QueryDSL | Schema 优先，类型安全 |

## GORM 快速入门

GORM 是 Go 最流行的 ORM，功能类似 JPA/Hibernate。

### 安装

```bash
go get gorm.io/gorm
go get gorm.io/driver/sqlite   # SQLite 驱动
go get gorm.io/driver/mysql    # MySQL 驱动
go get gorm.io/driver/postgres # PostgreSQL 驱动
```

### 模型定义 (类似 JPA @Entity)

```go
package model

import (
    "time"
    "gorm.io/gorm"
)

// User 用户模型
// 字段标签类似 JPA 的 @Column 注解
type User struct {
    ID        uint           `gorm:"primaryKey"`                    // 主键
    Name      string         `gorm:"size:64;uniqueIndex"`           // 唯一索引
    Email     string         `gorm:"size:128;not null"`             // 非空
    Age       int            `gorm:"default:0"`                     // 默认值
    CreatedAt time.Time      `gorm:"autoCreateTime"`                // 自动创建时间
    UpdatedAt time.Time      `gorm:"autoUpdateTime"`                // 自动更新时间
    DeletedAt gorm.DeletedAt `gorm:"index"`                         // 软删除
}

// Todo 待办模型
type Todo struct {
    ID        uint      `gorm:"primaryKey"`
    UserID    uint      `gorm:"index"`                              // 外键索引
    Title     string    `gorm:"size:256;not null"`
    Done      bool      `gorm:"default:false"`
    CreatedAt time.Time

    User      User      `gorm:"foreignKey:UserID"`                  // 关联
}
```

### 连接数据库

```go
package database

import (
    "fmt"
    "log"

    "gorm.io/driver/sqlite"
    "gorm.io/driver/mysql"
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
)

// ConnectSQLite 连接 SQLite (开发/测试)
func ConnectSQLite(dbPath string) (*gorm.DB, error) {
    return gorm.Open(sqlite.Open(dbPath), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Info),
    })
}

// ConnectMySQL 连接 MySQL (生产)
func ConnectMySQL(host, user, pass, dbname string, port int) (*gorm.DB, error) {
    dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
        user, pass, host, port, dbname)
    return gorm.Open(mysql.Open(dsn), &gorm.Config{})
}

// AutoMigrate 自动迁移 (类似 Hibernate ddl-auto=update)
func AutoMigrate(db *gorm.DB, models ...interface{}) error {
    return db.AutoMigrate(models...)
}
```

### CRUD 操作

```go
package repository

import (
    "gorm.io/gorm"
)

type UserRepository struct {
    db *gorm.DB
}

func NewUserRepository(db *gorm.DB) *UserRepository {
    return &UserRepository{db: db}
}

// Create 创建用户 (类似 JPA save)
func (r *UserRepository) Create(user *User) error {
    return r.db.Create(user).Error
}

// FindByID 根据 ID 查询 (类似 JPA findById)
func (r *UserRepository) FindByID(id uint) (*User, error) {
    var user User
    err := r.db.First(&user, id).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// FindByName 条件查询 (类似 JPA findByName)
func (r *UserRepository) FindByName(name string) (*User, error) {
    var user User
    err := r.db.Where("name = ?", name).First(&user).Error
    return &user, err
}

// FindAll 查询所有 (类似 JPA findAll)
func (r *UserRepository) FindAll() ([]User, error) {
    var users []User
    err := r.db.Find(&users).Error
    return users, err
}

// Update 更新用户 (类似 JPA save)
func (r *UserRepository) Update(user *User) error {
    return r.db.Save(user).Error
}

// UpdateFields 部分更新
func (r *UserRepository) UpdateFields(id uint, fields map[string]interface{}) error {
    return r.db.Model(&User{}).Where("id = ?", id).Updates(fields).Error
}

// Delete 删除用户 (软删除)
func (r *UserRepository) Delete(id uint) error {
    return r.db.Delete(&User{}, id).Error
}

// HardDelete 硬删除
func (r *UserRepository) HardDelete(id uint) error {
    return r.db.Unscoped().Delete(&User{}, id).Error
}
```

### 事务处理 (类似 @Transactional)

```go
// TransferMoney 转账示例
func TransferMoney(db *gorm.DB, fromID, toID uint, amount int) error {
    // 方式 1: Transaction 回调 (推荐)
    return db.Transaction(func(tx *gorm.DB) error {
        // 扣款
        if err := tx.Model(&Account{}).
            Where("id = ? AND balance >= ?", fromID, amount).
            Update("balance", gorm.Expr("balance - ?", amount)).Error; err != nil {
            return err // 返回错误自动回滚
        }

        // 入账
        if err := tx.Model(&Account{}).
            Where("id = ?", toID).
            Update("balance", gorm.Expr("balance + ?", amount)).Error; err != nil {
            return err
        }

        return nil // 返回 nil 自动提交
    })
}

// 方式 2: 手动控制
func ManualTransaction(db *gorm.DB) error {
    tx := db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()

    if err := tx.Create(&User{Name: "test"}).Error; err != nil {
        tx.Rollback()
        return err
    }

    return tx.Commit().Error
}
```

### 关联查询

```go
// 预加载关联 (类似 JPA fetch = EAGER)
func (r *TodoRepository) FindWithUser(id uint) (*Todo, error) {
    var todo Todo
    err := r.db.Preload("User").First(&todo, id).Error
    return &todo, err
}

// 查询用户的所有待办
func (r *UserRepository) FindWithTodos(userID uint) (*User, error) {
    var user User
    err := r.db.Preload("Todos").First(&user, userID).Error
    return &user, err
}
```

---

## 完整示例

```go
package main

import (
    "fmt"
    "log"

    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID    uint   `gorm:"primaryKey"`
    Name  string `gorm:"size:64;uniqueIndex"`
    Email string `gorm:"size:128"`
    Age   int
}

func main() {
    // 1. 连接数据库 (内存 SQLite)
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    if err != nil {
        log.Fatal(err)
    }

    // 2. 自动迁移
    db.AutoMigrate(&User{})

    // 3. 创建
    user := User{Name: "张三", Email: "zhang@example.com", Age: 25}
    db.Create(&user)
    fmt.Println("创建用户 ID:", user.ID)

    // 4. 查询
    var found User
    db.First(&found, "name = ?", "张三")
    fmt.Printf("查询结果: %+v\n", found)

    // 5. 更新
    db.Model(&found).Update("Age", 26)
    fmt.Println("更新后年龄:", found.Age)

    // 6. 事务
    db.Transaction(func(tx *gorm.DB) error {
        tx.Create(&User{Name: "李四", Email: "li@example.com"})
        tx.Create(&User{Name: "王五", Email: "wang@example.com"})
        return nil
    })

    // 7. 查询所有
    var users []User
    db.Find(&users)
    fmt.Println("所有用户:")
    for _, u := range users {
        fmt.Printf("  - %s (%s)\n", u.Name, u.Email)
    }
}
```

---

## Java vs Go 对照

| JPA/Hibernate | GORM | 说明 |
|---------------|------|------|
| `@Entity` | `type X struct` | 实体定义 |
| `@Id @GeneratedValue` | `gorm:"primaryKey"` | 主键 |
| `@Column(unique=true)` | `gorm:"uniqueIndex"` | 唯一约束 |
| `@ManyToOne` | `gorm:"foreignKey:X"` | 外键关联 |
| `EntityManager.persist()` | `db.Create()` | 创建 |
| `EntityManager.find()` | `db.First()` | 查询 |
| `EntityManager.merge()` | `db.Save()` | 更新 |
| `EntityManager.remove()` | `db.Delete()` | 删除 |
| `@Transactional` | `db.Transaction()` | 事务 |
| `ddl-auto=update` | `db.AutoMigrate()` | 自动建表 |

---

## 练习

1. 将 `internal/todo` 从内存存储改为 SQLite + GORM
2. 添加 User 模型，实现 Todo 与 User 的关联
3. 实现带分页的列表查询
