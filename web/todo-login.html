<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO ç™»å½• - Learn4Go</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8fafc; }
        .card { border: 1px solid #e2e8f0; box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
        .btn-primary { background: #0ea5e9; border: none; }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center" style="min-height:100vh;">
    <div class="card p-4" style="width: 420px;">
    <h4 class="mb-3">ğŸ” TODO API ç™»å½•</h4>
    <p class="text-muted mb-2">æ¼”ç¤ºå‰ç«¯ä¸åˆ·æ–°ä»¤ç‰Œè”åŠ¨ã€‚é»˜è®¤è´¦æˆ·ï¼šadmin@example.com / admin123</p>
    <div class="alert alert-info py-2 px-3">
        éœ€è¦åç«¯ <code>cmd/todoapi</code> è¿è¡Œï¼ˆå¯æ‰§è¡Œ <code>./start-local.sh</code>ï¼‰ã€‚æœ¬é¡µä¸å¯ç”¨ mockï¼›å¦‚éœ€ mockï¼Œè¯·æ”¹ç”¨ <code>login.html?mock=true</code>ã€‚
    </div>
    <div class="mb-3">
        <label class="form-label">é‚®ç®±</label>
        <input id="email" type="email" class="form-control" placeholder="you@example.com" required>
    </div>
    <div class="mb-3">
        <label class="form-label">å¯†ç </label>
        <input id="password" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
    </div>
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="form-text" id="status-text">å°šæœªç™»å½•</div>
        <button id="logout-btn" class="btn btn-outline-secondary btn-sm" type="button">é€€å‡º</button>
    </div>
    <button id="login-btn" class="btn btn-primary w-100 mb-3" type="button">ç™»å½•å¹¶è·å– Token</button>
    <div class="alert alert-danger d-none" id="error-box"></div>
    <div class="alert alert-success d-none" id="success-box"></div>
</div>

<script src="config.js"></script>
<script src="auth-helper.js"></script>
<script>
    const api = window.AppConfig?.todoApiBaseUrl || '';
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const errBox = document.getElementById('error-box');
    const okBox = document.getElementById('success-box');
    const statusText = document.getElementById('status-text');

    function setStatus(text, isError=false) {
        statusText.textContent = text;
        errBox.classList.toggle('d-none', !isError);
        errBox.textContent = isError ? text : '';
    }

    async function login() {
        errBox.classList.add('d-none');
        okBox.classList.add('d-none');
        loginBtn.disabled = true;
        loginBtn.textContent = 'ç™»å½•ä¸­...';
        try {
            const resp = await fetch(`${api}/v1/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                })
            });
            const data = await resp.json();
            if (!resp.ok) {
                setStatus(data.error || 'ç™»å½•å¤±è´¥', true);
                return;
            }
            AuthClient.setTokens(data.token, data.refresh_token);
            okBox.textContent = `ç™»å½•æˆåŠŸï¼Œè§’è‰²: ${data.user.role}`;
            okBox.classList.remove('d-none');
            setStatus(`Access è¿‡æœŸï¼š${data.expires_in}sï¼ŒRefresh è¿‡æœŸï¼š${data.refresh_expires_in}s`);
        } catch (e) {
            setStatus('ç½‘ç»œå¼‚å¸¸ï¼Œæ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ', true);
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'ç™»å½•å¹¶è·å– Token';
        }
    }

    async function fetchMe() {
        const resp = await AuthClient.authFetch(`${api}/v1/todos`, { method: 'GET' });
        const data = await resp.json();
        if (resp.ok) {
            okBox.textContent = `å·²è·å– TODO åˆ—è¡¨ï¼Œæ¡ç›®æ•°: ${data.length}`;
            okBox.classList.remove('d-none');
            setStatus('Token æœ‰æ•ˆ');
        } else {
            setStatus(data.error || 'è·å–å¤±è´¥', true);
        }
    }

    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', () => {
        AuthClient.clear();
        setStatus('å·²é€€å‡ºï¼Œç¼“å­˜æ¸…ç©º');
        okBox.classList.add('d-none');
    });

    // é¡µé¢åŠ è½½åå°è¯•ç›´æ¥è°ƒç”¨å—ä¿æŠ¤æ¥å£ï¼Œè‹¥ 401 å°†è‡ªåŠ¨åˆ·æ–°
    fetchMe().catch(() => setStatus('å°šæœªç™»å½•'));
</script>
</body>
</html>
