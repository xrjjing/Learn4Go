# 生产环境部署指南

## 概述

本文档介绍 Learn4Go TODO API 的生产环境部署方案。

## 部署方式

### 1. 二进制部署

```bash
# 构建
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o todoapi ./cmd/todoapi

# 部署到服务器
scp todoapi user@server:/opt/todoapi/

# 创建 systemd 服务
sudo tee /etc/systemd/system/todoapi.service <<EOF
[Unit]
Description=TODO API Service
After=network.target mysql.service

[Service]
Type=simple
User=todoapi
Group=todoapi
WorkingDirectory=/opt/todoapi
Environment=TODO_STORAGE=mysql
Environment=TODO_DB_HOST=localhost
Environment=TODO_DB_PORT=3306
Environment=TODO_DB_USER=todoapi
Environment=TODO_DB_PASS=your_password
Environment=TODO_DB_NAME=learn4go
Environment=JWT_SECRET=your_jwt_secret_32chars_minimum
ExecStart=/opt/todoapi/todoapi
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable todoapi
sudo systemctl start todoapi
```

### 2. Docker 部署

```bash
# 构建镜像
docker build -t learn4go-todoapi:latest .

# 运行
docker run -d \
  --name todoapi \
  -p 8080:8080 \
  -e TODO_STORAGE=mysql \
  -e TODO_DB_HOST=mysql \
  -e TODO_DB_USER=todoapi \
  -e TODO_DB_PASS=your_password \
  -e TODO_DB_NAME=learn4go \
  -e JWT_SECRET=your_jwt_secret \
  --restart unless-stopped \
  learn4go-todoapi:latest
```

### 3. Docker Compose 部署

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  todoapi:
    build: .
    ports:
      - "8080:8080"
    environment:
      - TODO_STORAGE=mysql
      - TODO_DB_HOST=mysql
      - TODO_DB_PORT=3306
      - TODO_DB_USER=todoapi
      - TODO_DB_PASS=${DB_PASSWORD}
      - TODO_DB_NAME=learn4go
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  mysql:
    image: mysql:8
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=learn4go
      - MYSQL_USER=todoapi
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
```

## 环境变量配置

| 变量 | 说明 | 必填 | 示例 |
|------|------|------|------|
| `TODO_STORAGE` | 存储类型 | 否 | `mysql`, `sqlite`, `memory` |
| `TODO_ADDR` | 监听地址 | 否 | `:8080` |
| `TODO_DB_HOST` | 数据库主机 | MySQL时必填 | `localhost` |
| `TODO_DB_PORT` | 数据库端口 | 否 | `3306` |
| `TODO_DB_USER` | 数据库用户 | MySQL时必填 | `todoapi` |
| `TODO_DB_PASS` | 数据库密码 | MySQL时必填 | `password` |
| `TODO_DB_NAME` | 数据库名 | 否 | `learn4go` |
| `JWT_SECRET` | JWT 密钥 | 生产必填 | `32+字符的随机字符串` |

## 生产环境检查清单

### 安全
- [ ] 设置强 JWT_SECRET（至少32字符）
- [ ] 数据库使用专用账户（非root）
- [ ] 配置防火墙规则
- [ ] 启用 HTTPS（通过 Nginx 反代）
- [ ] 定期轮换密钥

### 可靠性
- [ ] 配置健康检查
- [ ] 设置自动重启
- [ ] 配置日志收集
- [ ] 设置监控告警

### 性能
- [ ] 调整数据库连接池参数
- [ ] 配置适当的超时时间
- [ ] 考虑使用 Redis 缓存

## Nginx 反向代理配置

```nginx
upstream todoapi {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    location / {
        proxy_pass http://todoapi;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    location /healthz {
        proxy_pass http://todoapi;
        access_log off;
    }
}
```

## 监控

### 健康检查端点

```bash
# 检查服务状态
curl http://localhost:8080/healthz

# 响应示例
{
  "status": "ok",
  "checks": {
    "database": "healthy"
  }
}
```

### 日志

服务使用 JSON 格式的结构化日志，便于收集和分析：

```json
{"time":"2025-12-05T12:00:00Z","level":"INFO","msg":"http request","method":"GET","path":"/v1/todos","status":200,"duration":"1.234ms"}
```

## 故障排查

### 常见问题

1. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证连接参数
   - 检查防火墙规则

2. **JWT 验证失败**
   - 确认 JWT_SECRET 一致
   - 检查 token 是否过期

3. **服务无法启动**
   - 检查端口是否被占用
   - 查看系统日志 `journalctl -u todoapi`
