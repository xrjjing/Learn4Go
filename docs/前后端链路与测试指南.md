# 前后端链路与测试指南

本文档汇总当前 Learn4Go 项目中 **前端 → 网关 → TODO API** 的完整链路设计，并给出在本机执行的 **冒烟测试脚本与步骤**，方便你随时对照与验证。

---

## 更新说明（2025-12-06）

- 已统一 TODO API 主路径为 `/v1/*`，通过网关访问的路径为 `/api/v1/*`；
- 相关文档（API 接口文档、本地开发指南、前端使用指南）、脚本（start-local.sh、test-smoke.sh、test-admin-api.sh、scripts 目录）与前端页面（login.html、admin.html、todo-login.html、portal.html）中的示例地址已全部对齐；
- 如在实际访问中遇到返回 404 / 401，请优先对照本指南中的链路图和 `scripts/README.md` 进行排查。 

## 一、整体架构概览

### 1. 主要组件

- **前端静态页面**：`web/`
  - `portal.html`：学习门户，展示服务状态与示例入口
  - `todo-login.html`：TODO API 登录 + Refresh 演示
  - `login.html` / `admin.html`：管理后台登录与用户 / 角色 / 权限管理
- **TODO API 服务**：`cmd/todoapi` + `internal/todo`
  - 业务接口：`/v1/*`
  - 健康检查：`/healthz`
- **API 网关示例**：`examples/gateway/`
  - `stdlib/main.go`：Go 标准库实现
  - `gin/main.go`：Gin 框架实现
- **Docker 部署**：`deployments/`
  - `docker-compose.yml`：启动 todoapi、gateway、nginx、数据库等
  - `nginx.conf`：对外暴露静态页面与 `/api/*` 代理

### 2. 三种典型访问链路

1. **本地直连 TODO API（开发模式主路径）**

```text
浏览器 (http://localhost:8000/*.html)
  ↓
web 静态服务器 (python -m http.server 8000)
  ↓
TODO API 直连 (http://127.0.0.1:8080/v1/...)
  ↓
internal/todo (认证 / RBAC / TODO 业务)
```

2. **本地 API Gateway（教学路径）**

```text
客户端 (curl 或浏览器)
  ↓
Gin/stdlib 网关 (http://127.0.0.1:8888/api/v1/...)
  ↓
TODO API (http://127.0.0.1:8080/v1/...)
  ↓
internal/todo
```

3. **Docker + Nginx + Gateway + TODO API（部署路径）**

```text
浏览器 (http://localhost)
  ↓
Nginx (80)
  ├── 静态文件: /
  └── /api/... → gateway:8888/api/...
          ↓
      Gin 网关:8888 (examples/gateway/gin)
          ↓
      TODO API:8080 (/v1/..., /healthz)
          ↓
      internal/todo
```

---

## 二、本地直连 TODO API 链路

### 1. 配置来源（web/config.js）

本地开发模式（hostname 为 localhost/127.0.0.1 时）：

```javascript
// web/config.js（本地分支）
window.AppConfig = {
  todoApiBaseUrl: "http://127.0.0.1:8080",
  gatewayUrl: "http://127.0.0.1:8888",
  apiBaseUrl: "http://127.0.0.1:8080", // 统一 RBAC / 管理后台 API
  logApiBaseUrl: "http://127.0.0.1:8002",
  enableMock: true,
};
```

### 2. 典型接口链路

#### 2.1 TODO 登录 + 列表（todo-login.html）

- 登录：

```text
todo-login.html
  → POST {todoApiBaseUrl}/v1/login
  → internal/todo.handleLogin
  → 返回 {token, refresh_token, expires_in, refresh_expires_in, user}
```

- Refresh：

```text
AuthClient.refreshToken()
  → POST {todoApiBaseUrl}/v1/refresh
  → internal/todo.handleRefresh
```

- 列表：

```text
AuthClient.authFetch({todoApiBaseUrl}/v1/todos)
  → authMiddleware 解析 JWT
  → authzMiddleware 做 RBAC 检查
  → /v1/todos handler 根据角色/用户返回对应 TODO 列表
```

#### 2.2 管理后台登录与用户信息（login.html → admin.html）

1. `login.html` 登录：

```text
login.html
  → POST {API_BASE}/v1/login
       Body: {"email": "<表单 username>", "password": "<表单 password>"}
  → internal/todo.handleLogin
  → 返回 token / user 信息
  → 前端存储 token 到 localStorage
```

2. 登录后判定是否是管理员：

```text
login.html
  → GET {API_BASE}/v1/me (Authorization: Bearer <token>)
  → internal/todo.handleGetCurrentUser
  → 如果 is_superuser=true 则跳转 admin.html，否则跳 index.html
```

3. `admin.html` 管理后台入口：

```text
admin.html
  → GET {API_BASE}/v1/me           → 当前管理员信息
  → GET {API_BASE}/v1/users        → 用户列表
  → POST {API_BASE}/v1/users       → 创建用户
  → PATCH {API_BASE}/v1/users/{id} → 更新用户状态（is_active 模拟）
  → GET {API_BASE}/v1/rbac/roles   → 角色列表
  → GET {API_BASE}/v1/rbac/permissions → 权限列表
```

所有这些调用都经过统一的 `apiFetch()` 封装，兼容两种返回格式：

- Go 直接 JSON：`{id,email,role,...}` / `[]`
- Python/Mock 风格：`{code:"OK", data:...}`。

### 3. 健康检查链路

- `portal.html` 服务状态卡片：

```text
todoApiBaseUrl + "/healthz"
  → internal/todo 健康检查 handler
  → 返回 {status: "ok"/"degraded", checks: {...}}
```

---

## 三、本地 Gateway 链路（Gin / stdlib）

### 1. 统一对外路径

为了与 TODO API 的 `/v1` 接口对齐，两个网关示例统一采用：

```text
网关健康：GET  http://localhost:8888/health
TODO 列表：GET  http://localhost:8888/api/v1/todos
```

### 2. stdlib 网关（examples/gateway/stdlib/main.go）

#### 2.1 路由映射

```go
// 通过 /api/v1/* 前缀识别后端服务
var backends = map[string]string{
  "/api/v1/todos": "http://localhost:8080",
  "/api/v1/users": "http://localhost:8081",
}
```

在 `router()` 中：

```go
for prefix, backend := range backends {
  if strings.HasPrefix(path, prefix) {
    // 将 /api 前缀剥离，后端看到的是 /v1/...
    if strings.HasPrefix(path, "/api/") {
      r.URL.Path = strings.TrimPrefix(path, "/api")
    }
    proxy := createProxy(backend)
    proxy.ServeHTTP(w, r)
    return
  }
}
```

因此：

```text
curl http://localhost:8888/api/v1/todos
  → 网关收到 path="/api/v1/todos"
  → 剥离 /api → path="/v1/todos"
  → 转发到 http://localhost:8080/v1/todos
```

### 3. Gin 网关（examples/gateway/gin/main.go）

#### 3.1 对外 API 路径

```go
// 根路径说明
r.GET("/", func(c *gin.Context) {
  c.JSON(http.StatusOK, gin.H{
    "status":  "ok",
    "message": "Learn4Go API Gateway",
    "version": "1.0",
    "routes":  []string{"/health", "/api/v1/todos", "/api/v1/users"},
  })
})

// API 组
api := r.Group("/api")
api.Use(AuthMiddleware())
api.Use(RateLimitMiddleware(100))
{
  // TODO API 代理
  todosProxy := createReverseProxy(backends["todos"].Target)
  api.Any("/v1/todos", todosProxy)
  api.Any("/v1/todos/*path", todosProxy)
  api.Any("/healthz", todosProxy) // /api/healthz -> /healthz

  // Users API 代理（示例）
  usersProxy := createReverseProxy(backends["users"].Target)
  api.Any("/v1/users", usersProxy)
  api.Any("/v1/users/*path", usersProxy)
}
```

`createReverseProxy` 内部同样剥离 `/api` 前缀：

```go
if strings.HasPrefix(req.URL.Path, "/api/") {
  req.URL.Path = strings.TrimPrefix(req.URL.Path, "/api")
}
```

---

## 四、Docker + Nginx 链路

### 1. Nginx 配置（deployments/nginx.conf）

核心部分：

```nginx
server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index portal.html index.html;

    # 前端静态文件
    location / {
        try_files $uri $uri/ /portal.html;
    }

    # API 代理到网关
    location /api/ {
        proxy_pass http://gateway:8888/api/;
        ...
    }
}
```

### 2. 对外统一路径

- 前端门户：`http://localhost`
- TODO API（经 Nginx + Gateway）：`http://localhost/api/v1/todos`
- 网关自身健康：`http://localhost/api/health`（由 Nginx 转发到 gateway:8888/health）
- TODO API 健康（经网关）：`http://localhost/api/healthz`

前端 Docker 配置对应 `web/config.js` 中 Docker 分支：

```javascript
window.AppConfig = {
  todoApiBaseUrl: "/api",
  gatewayUrl: "/api",
  apiBaseUrl: "/api",
  logApiBaseUrl: "/api",
  enableMock: false,
};
```

---

## 五、测试脚本与执行指南

### 1. 一键本地冒烟测试脚本：test-smoke.sh

脚本路径：`test-smoke.sh`

#### 1.1 功能概要

1. 检查 TODO API 直连健康状态：`GET http://127.0.0.1:8080/healthz`
2. 用默认账号登录获取 token：`POST /v1/login`（admin@example.com / admin123）
3. 带 token 访问 TODO 列表：`GET /v1/todos`
4. 如果检测到 Gateway 在 `:8888` 监听：
   - 再访问：`GET http://127.0.0.1:8888/api/v1/todos`（带同一 token）

#### 1.2 运行前准备

```bash
cd /Users/xrj/GoProject/Learn4Go-1

# 确保安装 jq（一次性操作）
# macOS:  brew install jq
# Ubuntu: sudo apt-get install jq

# 启动 TODO API（建议内存模式）
go run ./cmd/todoapi
```

建议在一个终端让 todoapi 常驻，再在另一个终端执行脚本。

#### 1.3 执行脚本

```bash
cd /Users/xrj/GoProject/Learn4Go-1
chmod +x test-smoke.sh   # 第一次运行需要
./test-smoke.sh
```

预期结果（示意）：

```text
[1/4] 检查 TODO API 直连健康状态...
✅ TODO API 健康检查通过

[2/4] 直连登录获取 Token（admin@example.com/admin123）...
✅ 登录成功，已获取访问 Token

[3/4] 直连访问 /v1/todos（带认证）...
✅ 直连 /v1/todos 成功，返回条目数: X

[4/4] 通过网关访问 /api/v1/todos（可选）...
⚠️  未检测到 Gateway 运行在 http://127.0.0.1:8888，跳过网关测试
```

如果你在另一个终端启动了 Gateway，例如：

```bash
go run ./examples/gateway/gin
# 或
go run ./examples/gateway/stdlib
```

则第四步会变成：

```text
✅ 通过网关 /api/v1/todos 成功，返回条目数: X
```

### 2. 管理后台 API 集成测试：test-admin-api.sh

脚本路径：`test-admin-api.sh`

功能：

- 健康检查 `/healthz`
- 登录 admin，获取 token
- 测试：
  - `GET /v1/me`
  - `GET /v1/users`
  - `GET /v1/rbac/roles`
  - `GET /v1/rbac/permissions`
  - `POST /v1/users` 创建用户
  - `POST /v1/logout`

用法（前提：TODO API 已启动）：

```bash
cd /Users/xrj/GoProject/Learn4Go-1
chmod +x test-admin-api.sh
./test-admin-api.sh
```

它会逐项输出每个管理接口是否通过，适合作为 **管理后台功能是否完好** 的快速检查。

### 3. Docker 部署环境验证（手动）

```bash
cd /Users/xrj/GoProject/Learn4Go-1/deployments
docker-compose up -d
docker-compose ps
```

验证：

- 浏览器访问：`http://localhost`（门户）
- curl 验证：

```bash
# 网关健康（经 Nginx）
curl http://localhost/api/health

# TODO API 列表（经 Nginx + 网关 + todoapi）
curl http://localhost/api/v1/todos
```

如果未登录，会返回 401/403；这证明链路已经通，只是缺少认证。

---

## 六、推荐使用顺序

1. **开发调试**：优先使用本地直连模式
   - `go run ./cmd/todoapi`
   - `cd web && python3 -m http.server 8000`
   - 浏览器：`http://localhost:8000/portal.html`
2. **接口快速验证**：
   - `./test-smoke.sh`：验证 TODO 核心链路
   - `./test-admin-api.sh`：验证管理后台接口
3. **架构演示**：
   - `go run ./examples/gateway/stdlib` 或 `gin`
   - 用 `curl http://localhost:8888/api/v1/todos` 感受网关转发
4. **部署级演示**：
   - `cd deployments && docker-compose up -d`
   - 浏览器访问 `http://localhost`
   - 用 `/api/v1/todos` 验证完整链路

---

## 七、故障排查思路（简要）

1. **curl 直连 8080 失败**：
   - 检查 todoapi 是否启动（取决于 `go run ./cmd/todoapi`）。
   - 检查端口是否被占用（`lsof -Pi :8080`）。
2. **/v1/login 报错**：
   - 确认请求体是 JSON `{email,password}`。
   - 使用默认账号：
     - `admin@example.com / admin123`
     - `user@example.com / user123`
     - `demo@example.com / demo123`
3. **前端 8000 端口报 CORS 错误**：
   - 确认 `internal/todo` 已启用 `corsMiddleware`（当前代码已启用）。
   - 确认浏览器请求的目标是 8080，而不是容器内部地址。
4. **通过网关访问 /api/v1/todos 报 502/404**：
   - 检查网关是否启动在 8888 端口。
   - 确认 TODO API 已在 8080 监听。
   - 用 `curl http://127.0.0.1:8080/healthz` 单独验证后端。

如需更深入的故障分析，可以结合 `logs/*.log` 与 `slog` 输出一起排查。需要时可以再补一个“故障排查专用”文档。  
当前文件主要用于 **快速对照链路设计与测试入口**。  
